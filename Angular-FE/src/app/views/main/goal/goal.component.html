

<div class="goal-container">
  <div class="animated-bg"></div>

  <button mat-raised-button color="accent" (click)="toggleForm()" *ngIf="!showForm">
    <mat-icon>add</mat-icon> T·∫°o M·ª•c Ti√™u M·ªõi
  </button>

 <mat-card class="goal-form-card animate-slide" *ngIf="showForm">
  <mat-card-header>
    <div mat-card-avatar class="goal-avatar">üéØ</div>
    <mat-card-title>{{ editingGoalId ? 'Ch·ªânh s·ª≠a m·ª•c ti√™u' : 'T·∫°o M·ª•c Ti√™u M·ªõi' }}</mat-card-title>
    <mat-card-subtitle>Thi·∫øt l·∫≠p m·ª•c ti√™u t√†i ch√≠nh c·ªßa b·∫°n</mat-card-subtitle>
    
    <!-- N√∫t h·ªßy ·ªü g√≥c ph·∫£i -->
    <button mat-icon-button class="close-btn" (click)="toggleForm()" matTooltip="ƒê√≥ng">
      <mat-icon>close</mat-icon>
    </button>
  </mat-card-header>

  <mat-card-content>
    <form [formGroup]="goalForm" (ngSubmit)="addGoal()">
      <!-- Nh√≥m 1 - Th√¥ng tin c∆° b·∫£n -->
     <div class="form-group">
    <h3>Th√¥ng tin c∆° b·∫£n</h3>
    
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Ti√™u ƒë·ªÅ m·ª•c ti√™u</mat-label>
      <input matInput formControlName="title" placeholder="V√≠ d·ª•: Mua xe, du l·ªãch Ch√¢u √Çu..." />
      <mat-error *ngIf="goalForm.get('title')?.hasError('required')">Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ</mat-error>
      <mat-error *ngIf="goalForm.get('title')?.hasError('minlength')">√çt nh·∫•t 3 k√Ω t·ª±</mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline" class="full-width">
      <mat-label>T√™n m·ª•c ti√™u</mat-label>
      <input matInput formControlName="name" placeholder="V√≠ d·ª•: M·ª•c ti√™u mua √¥ t√¥ 2025" />
      <mat-error *ngIf="goalForm.get('name')?.hasError('required')">Vui l√≤ng nh·∫≠p t√™n m·ª•c ti√™u</mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Lo·∫°i m·ª•c ti√™u</mat-label>
      <mat-select formControlName="type">
        <mat-option *ngFor="let type of goalTypes" [value]="type.value">
          {{type.label}}
        </mat-option>
      </mat-select>
      <mat-error *ngIf="goalForm.get('type')?.hasError('required')">Vui l√≤ng ch·ªçn lo·∫°i m·ª•c ti√™u</mat-error>
    </mat-form-field>
  </div>

      <!-- Nh√≥m 2 - S·ªë ti·ªÅn (ch·ªâ hi·ªÉn th·ªã khi ƒë√£ ch·ªçn lo·∫°i) -->
      <div *ngIf="goalForm.get('type')?.value" class="form-layout">
        <div class="form-column">
          <div class="form-group">  
            <h3>S·ªë ti·ªÅn</h3>
            
            <div class="amount-fields">
              <mat-form-field appearance="outline">
                <mat-label>S·ªë ti·ªÅn b·∫Øt ƒë·∫ßu</mat-label>
                <input matInput type="number" formControlName="startAmount">
                <span matTextSuffix>‚Ç´</span>
                <mat-error *ngIf="goalForm.get('startAmount')?.hasError('required')">Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn</mat-error>
                <mat-error *ngIf="goalForm.get('startAmount')?.hasError('min')">S·ªë ti·ªÅn kh√¥ng ƒë∆∞·ª£c √¢m</mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>S·ªë ti·ªÅn k·∫øt th√∫c</mat-label>
                <input matInput type="number" formControlName="targetAmount" matTooltip="T·ªïng s·ªë ti·ªÅn b·∫°n mu·ªën ƒë·∫°t ƒë∆∞·ª£c">
                <span matTextSuffix>‚Ç´</span>
                <mat-error *ngIf="goalForm.get('targetAmount')?.hasError('required')">Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn</mat-error>
                <mat-error *ngIf="goalForm.get('targetAmount')?.hasError('min')">S·ªë ti·ªÅn ph·∫£i l·ªõn h∆°n 0</mat-error>
              </mat-form-field>
            </div>

            <div class="total-milestones">
              T·ªïng c√°c m·ªëc: {{formatCurrency(getTotalMilestones())}} / {{formatCurrency(goalForm.get('targetAmount')?.value || 0)}}
            </div>
          </div>
        </div>
      </div>

        <!-- Nh√≥m 3 - C√°c m·ªëc ti·∫øn tr√¨nh (chi·∫øm full width) -->
        <div class="form-group">
          <h3>C√°c m·ªëc ti·∫øn tr√¨nh</h3>
          <p class="hint-text">Thi·∫øt l·∫≠p c√°c m·ªëc ti·ªÅn c·∫ßn ƒë·∫°t ƒë∆∞·ª£c</p>

          <div formArrayName="milestones" class="milestones-grid">
            <ng-container *ngFor="let milestoneCtrl of milestones.controls; let i = index; let odd = odd">
              <!-- Hi·ªÉn th·ªã m·ªëc ·ªü c·ªôt tr√°i (s·ªë l·∫ª) -->
              <div class="milestone-column" *ngIf="odd">
                <div class="milestone-item">
                  <mat-form-field appearance="outline" class="milestone-input">
                    <mat-label>M·ªëc {{i + 1}}</mat-label>
                    <input matInput type="number" [formControl]="milestoneCtrl"
                      [placeholder]="'V√≠ d·ª•: ' + (1000000 * (i+1) * 5) + '‚Ç´'">
                    <span matTextSuffix>‚Ç´</span>
                    <mat-error *ngIf="milestoneCtrl.hasError('required')">Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn</mat-error>
                    <mat-error *ngIf="milestoneCtrl.hasError('min')">S·ªë ti·ªÅn ph·∫£i l·ªõn h∆°n 0</mat-error>
                  </mat-form-field>
                  <button mat-icon-button color="warn" type="button" (click)="removeMilestone(i)"
                    *ngIf="milestones.length > 1" matTooltip="X√≥a m·ªëc" class="delete-btn">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>

              <!-- Hi·ªÉn th·ªã m·ªëc ·ªü c·ªôt ph·∫£i (s·ªë ch·∫µn) -->
             <div class="milestone-column" *ngIf="!odd && i > 0">
  <div class="milestone-item">
    <mat-form-field appearance="outline" class="milestone-input">
      <mat-label>M·ªëc {{i + 1}}</mat-label>
      <input matInput type="number" [formControl]="milestoneCtrl" 
             [placeholder]="'V√≠ d·ª•: ' + (1000000 * (i+1) * 5) + '‚Ç´'">
      <span matTextSuffix>‚Ç´</span>
      <mat-error *ngIf="milestoneCtrl.hasError('required')">Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn</mat-error>
      <mat-error *ngIf="milestoneCtrl.hasError('min')">S·ªë ti·ªÅn ph·∫£i l·ªõn h∆°n 0</mat-error>
    </mat-form-field>
    <button mat-icon-button color="warn" type="button" (click)="removeMilestone(i)"
            *ngIf="milestones.length > 1" matTooltip="X√≥a m·ªëc" class="delete-btn">
      <mat-icon>delete</mat-icon>
    </button>
  </div>
</div>
            </ng-container>
          </div>

          <button mat-button type="button" (click)="addMilestone()" class="add-milestone-btn">
            <mat-icon>add</mat-icon> Th√™m M·ªëc
          </button>

          <div *ngIf="goalForm.get('milestones')?.hasError('exceedsTarget')" class="error-text">
            C√°c m·ªëc kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° s·ªë ti·ªÅn k·∫øt th√∫c.
          </div>
          <div *ngIf="goalForm.get('milestones')?.hasError('invalidOrder')" class="error-text">
            C√°c m·ªëc ph·∫£i theo th·ª© t·ª± tƒÉng d·∫ßn.
          </div>
        </div>

        <!-- Nh√≥m 4 - H√†nh ƒë·ªông -->
        <div class="form-actions">
          <button mat-raised-button color="primary" type="submit" [disabled]="isLoading">
            <span *ngIf="!isLoading && !isSuccess">
              <mat-icon>save</mat-icon> {{ editingGoalId ? 'C·∫≠p nh·∫≠t' : 'L∆∞u M·ª•c Ti√™u' }}
            </span>
            <span *ngIf="isLoading">
              <mat-icon class="spin-icon">autorenew</mat-icon> ƒêang x·ª≠ l√Ω...
            </span>
            <span *ngIf="isSuccess && !isLoading">
              <mat-icon>check_circle</mat-icon> Th√†nh c√¥ng!
            </span>
          </button>
          <button mat-button type="button" (click)="toggleForm()">H·ªßy</button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Danh s√°ch m·ª•c ti√™u -->
  <div *ngFor="let goal of goals" class="goal-card">
    <mat-card>
      <mat-card-header>
        <div mat-card-avatar class="goal-avatar">
          <span *ngIf="goal.type === 'Target'">üíº</span>
          <span *ngIf="goal.type === 'Milestone'">üí∞</span>
          <!-- <span *ngIf="goal.type === 'house'">üè†</span>
          <span *ngIf="goal.type === 'car'">üöó</span> -->
        </div>
        <mat-card-title>{{goal.title}}</mat-card-title>
        <mat-card-subtitle>{{goal.name}}</mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <div class="progress-info">
          <span class="amount">{{formatCurrency(goal.milestones[goal.progress-1] || goal.startAmount)}} /
            {{formatCurrency(goal.targetAmount)}}</span>
          <span class="percentage">{{getProgressPercentage(goal)}}%</span>
        </div>

        <mat-progress-bar mode="determinate" [value]="getProgressPercentage(goal)" color="primary"></mat-progress-bar>

        <div class="milestones">
          <div *ngFor="let milestone of goal.milestones; let i = index" class="milestone"
            [class.completed]="goal.progress > i" [class.current]="goal.progress === i"
            matTooltip="M·ªëc {{i+1}}: {{formatCurrency(milestone)}}">
            <div class="milestone-marker" [@goalStop]="getMilestoneState(goal, i)"></div>
            <div class="milestone-amount">{{formatCurrency(milestone)}}</div>
          </div>
        </div>
      </mat-card-content>

      <mat-card-actions>
        <button mat-button color="primary" (click)="updateProgress(goal)" [disabled]="goal.isCompleted">
          <mat-icon>add</mat-icon> C·∫≠p nh·∫≠t ti·∫øn ƒë·ªô
        </button>
        <button mat-button color="warn" (click)="editGoal(goal)">
          <mat-icon>edit</mat-icon> Ch·ªânh s·ª≠a
        </button>
      </mat-card-actions>
    </mat-card>
  </div>

  <!-- Popup ch√∫c m·ª´ng -->
  <div *ngIf="showCongratsPopup" class="congrats-popup">
    <div class="congrats-content">
      <h2>{{ congratsMessage }}</h2>
      <button mat-raised-button color="primary" (click)="closeCongratsPopup()">ƒê√≥ng</button>
    </div>
  </div>
</div>